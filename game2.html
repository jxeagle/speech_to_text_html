<html>
  <head>
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap@4.5.2/dist/css/bootstrap.min.css"/>
    <link type="text/css" rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0-rc2/css/bootstrap-glyphicons.css"/>
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css"/>
    <link rel="stylesheet" href="cards.css">
  </head>
  <body>
    <div id="app" class="container">
      <div class="row">
        <div class="cards col-12">
          <section :class=card_class(card) :value=card.display v-for="card in cards">
            <div class="card__inner card__inner--centered">
              <div class="card__column">
                <div class="card__symbol"></div>
                <div class="card__symbol"></div>
              </div>
            </div>
          </section>
        </div>
        <div class="col" style="font-size: xx-large;">
          <div>
            <ul>
              <li style="font-size: xx-large;">记住后说: "记好了"</li>
              <li style="font-size: xx-large;">做下一道题说: "下一个" </li>
            </ul>
          </div>

          <div class="alert alert-primary" role="alert">
            {{currentCardDisplay}}
          </div>

          <div v-show=waiting>
            <div class="text-center">
              <progress value="10" max="10" id="pageBeginCountdown"></progress>
              <p><span id="pageBeginCountdownText">10 </span> 秒后可以开始回答</p>
            </div>
          </div>

        </div>
      </div>
    </div>
    <script src="//unpkg.com/jquery@3.1.1/dist/jquery.slim.min.js"></script>
    <script src="//unpkg.com/tether@1.4.0/dist/js/tether.min.js"></script>
    <script src="//unpkg.com/bootstrap@4.0.0-alpha.6/dist/js/bootstrap.min.js"></script>
    <script src="//unpkg.com/moment@2.22.2/moment.js"></script>
    <script src="//unpkg.com/axios/dist/axios.min.js"></script>
    <script src="//unpkg.com/vue@2.2.5/dist/vue.js" type="text/javascript"></script>
    <script src="//unpkg.com/babel-polyfill@6.26.0/dist/polyfill.min.js"></script>
    <script src="//unpkg.com/bootstrap-vue@2.0.0-rc.20/dist/bootstrap-vue.js"></script>
    <script src="//unpkg.com/@tensorflow/tfjs@3.0.0/dist/tf.min.js"></script>
    <script src="//unpkg.com/@tensorflow-models/speech-commands@0.5.4/dist/speech-commands.min.js"></script>
    <script src="countdown.js"></script>

    <script>
      const deck = [];
      // from 1-13 and club,diamond,heart,spade, create a deck of cards
      for (let i = 1; i <= 13; i++) {
        let display = i;
        if (display === 1) display = 'A';
        if (display === 11) display = 'J';
        if (display === 12) display = 'Q';
        if (display === 13) display = 'K';
        deck.push({ value: '' + i, display: display, suit: 'club', });
        deck.push({ value: '' + i, display: display, suit: 'diamond' });
        deck.push({ value: '' + i, display: display, suit: 'heart' });
        deck.push({ value: '' + i, display: display, suit: 'spade' });
      }
      var esg_nlp = new Vue({
        el: '#app',
        data: {
          recognizer: null,
          cards: [],
          currentRank: {},
          currentSuit: {},
          currentCardDisplay: '',
          waiting: false,
          suitMap: {
            'club': '梅花',
            'diamond': '方块',
            'heart': '红桃',
            'spade': '黑桃',
          },
        },
        methods: {
          card_class: (card) => {
            let classes = ['card', 'card--' + card.suit]
            if (card.hidden) {
              classes.push('card--flipped')
            }
            // join the classes into a string
            return classes.join(' ')
          },
          pick_cards: (app) => {
            // pick 5 distinct cards from the deck
            const shuffled = deck.sort(() => 0.5 - Math.random());
            app.cards = shuffled.slice(0, 5).map(card => {
              c = Object.assign({}, card);
              c.hidden = false;
              return c
            });
            // log the cards to the console
            console.log(app.cards.map(card => card.value + card.suit).join(' '));

          },
          add_command: (command, app) => {
            if (command === 'start') {
              console.log('开始');
              app.pick_cards(esg_nlp);
            } else if (command === 'ready') {
              // set the hidden for all the cards to true
              app.cards.forEach(card => card.hidden = true);

              app.waiting = true;

              ProgressCountdown(10, 'pageBeginCountdown', 'pageBeginCountdownText')
              .then(function (value) {
                console.log('Countdown finished!');
                app.waiting=false;
              });

              console.log('准备');
            } else {

              // remove the outdated commands
              if ( (app.currentSuit && app.currentSuit.tm < new Date() - 2000)) {
                app.currentSuit = {};
              }
              if ( (app.currentRank && app.currentRank.tm < new Date() - 2000)) {
                app.currentRank = {};
              }

              // if the command is one of the suites
              if (['club', 'diamond', 'heart', 'spade'].includes(command)) {
                console.log('suit: ' + command)
                app.currentSuit = {command: command, tm: new Date()};
              } else {
                console.log('rank: ' + command)
                app.currentRank = {command: command, tm: new Date()};
              }

              // set the display of the current word
              if (app.currentSuit || app.currentRank) {
                app.currentCardDisplay = (app.suitMap[app.currentSuit?.command] || '') + (app.currentRank?.command || '');
              }

              // if the currentSuit and currentRank are set and
              // their tm are not off by more than 1 second, then it is an answer
              if (app.currentSuit && app.currentRank) {
                if (Math.abs(app.currentSuit.tm - app.currentRank.tm) < 2000) {
                  // here we have an answer
                  // find its match in app.cards
                  console.log('answer: ' + app.currentRank.command + ' ' + app.currentSuit.command)
                  const card = app.cards.find(card => card.suit === app.currentSuit.command && card.value === app.currentRank.command);
                  if (card) {
                    card.hidden = false;
                  }
                  app.currentSuit = null;
                  app.currentRank = null;
                }
              }
            }
          },
          init_recognizer: async (app) => {
            const recognizer = await speechCommands.create(
              'BROWSER_FFT', undefined,
              'http://localhost:5500/model/play-cards.json',
              'http://localhost:5500/model/play-cards.metadata.json');
            await recognizer.ensureModelLoaded();

            recognizer.listen(result => {
              // log the word with the highest score
              const scores = result.scores;
              const maxScoreIndex = scores.indexOf(Math.max(...scores));
              const word = recognizer.wordLabels()[maxScoreIndex];
              const score = scores[maxScoreIndex];
              app.add_command(word, app)
              console.log(word, score);
            }, {
              includeSpectrogram: true,
              probabilityThreshold: 0.93,
              overlapFactor: 0.6
            });
            return recognizer;
          },
        },
        mounted() {
          this.init_recognizer(this);
          this.pick_cards(this);
          console.log('mounted');
        }
      });
    </script>
  </body>
</html>